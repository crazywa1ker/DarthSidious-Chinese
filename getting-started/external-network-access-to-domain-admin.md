# 从外部网络获取域管理员权限

#### 简介

本文讲解一种域渗透测试方案。该方案的背景是你已经拥有了对具有一个或多个域网络的内部访问权限，但我们的目标是获取域管理员权限。

在某些测试活动中，我们通常拥有某种级别的内部网络访问权限。但这并不意味着你可以跳过之前的这些部分。虽然互联网上有一些工具可能会帮助你进行域名管理，但在此我将介绍一种手动方式查找获取DA权限所需信息的方法。

### 操作步骤

一般而言从外部网络取得域管理权限包括许多步骤。 在真实的域渗透中情况通常比较复杂，需要你采用多种方式进行测试，不会都像本文概述的线性方式去实现。但是，本文阐述的这些步骤应该可以帮助你构建其域渗透测试的方案。

## 枚举外部网络

**目标:发现目标机器或者服务** 你一般处在外部网络上，也就是通常意义上的Internet。并且选定了一个目标，如果目标是实验室环境，则已有一组IP地址可用。我们的第一步是要枚举一组IP或子网。一旦发现一个或多个目标机器和服务，就应该彻底地调查它们。

**技术**

* 端口扫描
* 调查暴露的服务

**值得关注的事情**

* IIS \(80, 443\)
* RDP \(3389\)
* MSSQL \(1433\)
* RDS \(3389\)
* RDWEB \(3389, navigate to [http://ip/rdweb](http://ip/rdweb)\)
* OWA \(80, navigate to subdomain email.domain.com or http://ip/owa\)

**工具**

* Nmap
* Firefox

## 获取域用户凭据

**目标: 获取域用户凭据**  这里的域用户可以是域中的任何用户。我们首先要做的是找出域名。获得域名后，我们就可以尝试一种称为密码喷洒(Password Spraying)的攻击技术。大多数企业都会提供多种身份验证方式，常见的比如Outlook的Web控制SMB等。这就意味着如果我们能够找出域账户名称的构成语法，我们就可以尝试使用通用密码进行身份验证。但是，在进行密码喷洒攻击时要注意锁定阈值，因为许多企业的安全策略都会设定五次尝试后锁定账户。

**方法**

* 找出域名
* 弄清楚域账户名的构成语法规则
* 获取一个域用户的账户名
* 获取一个域用户的密码
* 
  **技术**

* 公开资源情报计划(OSINT)
* 调查公开服务的内容
* 对OWA(Outlook Web Access)进行密码喷洒攻击
* 验证凭证的其他方法 \(RDP\)

**Tools**

* OSINT
* Burp Intruder
* Mailsniper

### 获取一个内部网络中的shell

**目标: 获取内部网络一台机器的shell** 此处的目标是在内网的某台主机或者服务上执行你的攻击载荷，使得目标可以主动回连到你的主机，也即在内网中获取一台机器的shell。

就像在2003年是黑客攻击使用的方法一样，最有效的就是你针对外部开放服务的某个漏洞进行攻击。比如wordpress，Sharepoint中的RCE或某处的SQL注入都是可以的。当然如果你没有发现某个漏洞的存在或者感觉无从下手的时候，一些工具可以帮助你进行攻击现有服务，比如:Ruler。如果以上方式都行不通，那么可以使用最后一种方式--钓鱼攻击，这种方式可能会帮助你获取某个系统的命令执行权限。但是，这种也是一种比较容易被发现的攻击方式。

**技术**

* Abusing外部开放服务
* 漏洞利用
* 钓鱼攻击

**Tools**

* Ruler
* Phishing with HTA payload
* Metasploit

### 命令行与控制器 \(C2\)

**目标: 建立一个到内部网络的通信系统** 通过SQL注入获得的shell通道可能并不稳定，不适合进一步工作。所以我们需要建立一个更好的通道来与系统进行交互。此处就是C2的用武之地。它的环境配置十分简单，无论你在家里的计算机还是使用AWS box都可以迅速配置。

**技术**

* 搭建一台C2服务器
* 打开服务器上的一个端口并设置为监听模式
* 从domain进行回连
* 建立持久性连接

**工具**

* Empire
* dnscat2
* Empire persistence modules

## 枚举内部网络

**目标: 查找内部网络中计算机上的漏洞**

**方法** 枚举域之前，我们要先获取一名域用户的shell并且建立一个和内部网络的稳定交互通信方式。

在此处使用商业化的漏洞扫描程序可以帮助我们尽可能多地发现切入点。

如果没有商业化的漏洞扫描工具，那么免费的nmap也是一个不错选择。但是在大型网络中扫描记得保持条理，因为扫描的输出信息还是很多的。

在域中最值得我们去发现的就是域控制器了，一般的大型域中会有好几个域控制器的存在。

此外我们还应当关注443端口的开放情况，因为SSL证书中往往包含着域名。于此类似的还有Outlook Web Access门户。

其实扫描与否完全取决于你目前的情况，如果你发现你的目标也就是域管理员非常接近，那么就没有必要花费大量时间扫描漏洞。如果你域中的计算机存在MS17-010漏洞，并且可以进一步利用的话，那么你就可以轻松的拿到一个system权限的shell了。但是有一点需要注意，受控网络内的端口和漏洞扫描通常会非常快速地被蓝队捕获。 所以如果你想要隐身的话，这不是一个好的选择。

**技术**

* 漏洞扫描
* 审查扫描结果
* 选择一个目标

**工具**

* Nessus
* Nmap
* Metasploit

## 自动枚举域

**目标: 计算机,用户,组和组策略对象(GPOs)的发现** 我倾向于尽可能多搜集有关域的信息。因此我们要查明域中都有哪些计算机，域中的用户有哪些，这些用户有什么样的隶属关系。此外，也可以枚举一些组策略对象。当然域中肯定会存在很多信任凭证。Bloodhound是我们在这步中使用的关键工具，它会帮助你找出一条攻击通路。Bloodhound会默认查询出到DA的最短路径，并且会给与你一些选项，比如:域的配置等。但是虽然BH会做一些自动化的工作，但人工进行枚举也是必须的。

**技术**

* 运行Bloodhound采集信息
* 寻找DA sessions
* 查找当前用户的本地管理员权限
* 探明到Domain Admin的路径

**工具**

* Bloodhound
* PowerView
* Empire

## 手动枚举域

**目标: 域权限提升** 通常你在域中只是一个常规用户并没有多少权限，也就是说你在域中任何的一台计算机上都是没有本地管理员权限的。在这个关键步骤中，你可以使用像Mimikatz这种工具。一种典型的操作过程是从工作站用户->工作站管理员->服务器管理员->域管理员。

值得注意的是你在一个已经打了各种最新补丁的AD环境中，进行本地权限提升攻击是十分困难的。

**技术**

* 验证你拥有的用户是否是任何计算机上的本地管理员
* 确定组成员身份
* 确定用户,组成员以及当前计算机的组策略对象
* 肯能的话可以在本地进行特权提升

**工具**

* Empire
* PowerView

## 靠近Domain Admin

**目标: 在有Domain Admin session的机器上执行命令** 一旦路径被部署好，你就可以在域中开始横向移动了。你如果知道AD是怎样构成的，你就明白不用在每一处都弹一个shell回来。而且如果你在一个不能直接连接外网的机器到处尝试弹shell，那么就有可能被检测到。但是如果环境某处可以联网，那么弹个shell也是一个不错的选择。正是因为我们不了解环境是否可以直接连接外网，所以我在此处直说命令执行而不说弹shell。虽然这两者差异不大，但是命令执行可能对你完成任务更有效。此外，你还要考虑到你在隧道上完成的这些操作，会随着深入网络内部，而增大网络延迟。所以越深入就越困难。

其实这个步骤很大程度上取决于域大小，安全程度和配置。 但是如果每个用户在其工作站上具有本地管理员访问权限，或者域中有数百个DA，那么这个步骤通常作用就很小了。

**技术**

* 选择一台有DA登录的目标机器
* 枚举这台机器的权限
* 查看是否可以远程执行命令

**工具**

* WinRM
* WMI
* PsExec
* Empire lateral movement modules

## 使用Hijack攻击来获取Domain Admin 权限

**目标: 用DA或者DA凭证来执行命令**  到目前为止，我们就可以在一个DA登录的机器上执行命令了。在这不我们的目标是获得DA权限。如果你是本地管理员账户的话，这就很容易了。你只要用mimikatz去获取用户的凭证就好了\(密码或者hashes\)。如果你不是这种情况，那么你就只能去使用令牌模拟来窃取DA的令牌。但是，如果根本无法获得管理员权限，你就应该开始枚举此机器中的本地管理员，并查看您是否可以获得相应的权限。

**技术**

* 是否是本地admin -> Mimikatz
* 否则 -> 枚举一下看谁是本地admin
* 从普通用户到本地admin

**Tools**

* Powershell
* PowerView
* Invoke-TokenImpersonation
* Invoke-InternalMonologue